<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Limpar XML - Support Tools</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        /* Adicionando um estilo básico para o feedback de múltiplos arquivos */
        .file-list-status { font-size: 0.85rem; color: var(--text-muted); margin-top: 5px; }
    </style>
</head>

<body>
    <main class="container flex-center">
        <div class="card" style="width: 100%; max-width: 600px; margin-top: 2rem;">
            <h2 class="text-center">Limpeza de XML em Lote</h2>
            <p class="text-center">Selecione um ou mais arquivos para processar.</p>

            <div class="form-group mt-4">
                <label for="xmlFile" class="form-label">Arquivos XML Originais:</label>
                <input type="file" id="xmlFile" accept=".xml" multiple>
                <div id="fileStatus" class="file-list-status"></div>
            </div>

            <div class="form-group">
                <label for="extraTags" class="form-label" style="display: flex; align-items: center;">
                    Tags Adicionais para Remover (opcional):
                </label>
                <input type="text" id="extraTags" class="form-input" placeholder="Ex: dPrevEntrega, obs...">
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                <button class="btn btn-primary" onclick="processAllXMLs()">
                    Processar Todos
                </button>
                <button class="btn btn-secondary" onclick="exportProcessedFiles()">
                    Exportar Tudo (.zip)
                </button>
            </div>

            <div class="form-group">
                <label for="output" class="form-label">Log de Processamento / Pré-visualização:</label>
                <textarea id="output" class="form-textarea" placeholder="O status do processamento aparecerá aqui..." readonly style="height: 200px;"></textarea>
            </div>
        </div>
    </main>

    <script>
        // Objeto para armazenar os arquivos processados temporariamente
        let processedFiles = [];

        async function processAllXMLs() {
            const fileInput = document.getElementById('xmlFile');
            const outputField = document.getElementById('output');
            
            if (!fileInput.files.length) {
                alert('Selecione ao menos um arquivo XML.');
                return;
            }

            processedFiles = []; // Limpa cache anterior
            outputField.value = "Iniciando processamento...\n";

            // Tags padrão
            const defaultTags = ['IBSCBS', 'vItem', 'infAdProd', 'IBSCBSTot', 'vNFTot', 'dPrevEntrega', 'cMunFGIBS', 'tpCredPresIBSZFM', 'infProdNFF', 'infSolicNFF', 'IS', 'gCred', 'indBemMovelUsado'];
            const extraTagsInput = document.getElementById('extraTags').value;
            const extraTags = extraTagsInput ? extraTagsInput.split(',').map(tag => tag.trim()).filter(tag => tag.length > 0) : [];
            const tagsToRemove = [...defaultTags, ...extraTags];

            // Itera sobre cada arquivo selecionado
            for (let file of fileInput.files) {
                const text = await file.text();
                const cleanedText = cleanXML(text, tagsToRemove);
                
                processedFiles.push({
                    name: file.name.replace(/\.xml$/i, '') + '_corrigido.xml',
                    content: `<?xml version="1.0" encoding="UTF-8"?>\n${cleanedText}`
                });

                outputField.value += `✓ ${file.name} processado.\n`;
            }
            
            outputField.value += `\nTotal: ${processedFiles.length} arquivos prontos para exportação.`;
        }

        function cleanXML(xmlText, tagsToRemove) {
            // Lógica de substituição de tPag
            const regexTPag = new RegExp(`(<tPag>)([\\s\\S]*?)(<\/tPag>)`, 'gi');
            let cleaned = xmlText.replace(regexTPag, '<tPag>99</tPag>');

            // Remove declarações XML iniciais
            cleaned = cleaned.replace(/<\?xml[^>]*\?>/gi, '').trim();

            tagsToRemove.forEach(tag => {
                // Remove tags com conteúdo e self-closing
                let regexSafe = new RegExp(`<${tag}[^>]*>([\\s\\S]*?)<\\/${tag}>`, 'gi');
                cleaned = cleaned.replace(regexSafe, '');
                let regexEmpty = new RegExp(`<${tag}[^>]*>\\s*<\\/${tag}>`, 'gi');
                cleaned = cleaned.replace(regexEmpty, '');
            });

            return cleaned.replace(/(\r\n|\n|\r){2,}/gm, '\n').trim();
        }

        async function exportProcessedFiles() {
            if (processedFiles.length === 0) {
                alert('Processe os arquivos antes de exportar.');
                return;
            }

            if (processedFiles.length === 1) {
                // Download direto se for apenas um arquivo
                const file = processedFiles[0];
                downloadFile(file.content, file.name, 'text/xml');
            } else {
                // Cria um ZIP se houver múltiplos
                const zip = new JSZip();
                processedFiles.forEach(file => {
                    zip.file(file.name, file.content);
                });

                const content = await zip.generateAsync({ type: "blob" });
                downloadFile(content, "xml_processados_lote.zip", "application/zip");
            }
        }

        function downloadFile(content, fileName, contentType) {
            const blob = content instanceof Blob ? content : new Blob([content], { type: contentType });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = fileName;
            link.click();
        }
    </script>
</body>
</html>
